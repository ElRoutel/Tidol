<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tidol Developer – Buscar</title>
<script src="/js/auth-guard.js"></script>
  <!-- CSS -->
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="css/integrado.css">
  <link rel="stylesheet" href="css/buscador.css">

  <link rel="stylesheet" href="css/sidebarIA.css">
  <!-- JS -->
  <script type="module" src="/js/main.js" defer></script>
</head>

<body>
  <!-- ===================== SIDEBAR ===================== -->
  <aside class="sidebar">

    <div class="profile">
      <img src="/default_cover.png" alt="Usuario" class="profile-pic">
      <span id="user-name">Usuario</span>
    </div>
    <ul class="sidebar-menu">
      <li><button onclick="location.href='/index_dev.html'">Inicio</button></li>
      <li><button onclick="location.href='subir_dev.html'">Subir Música</button></li>
      <li><button class="active" onclick="location.href='buscar_dev.html'">Buscar</button></li>
      <li><button onclick="location.href='albumes_dev.html'">Álbumes</button></li>
      <li><button onclick="location.href='artistas_dev.html'">Artistas</button></li>
    </ul>
  </aside>

  <!-- ===================== CONTENIDO PRINCIPAL ===================== -->
  <main class="main-content">
    <div class="search-bar">
      <input type="text" id="search-input" placeholder="Buscar canción, álbum o artista...">
      <button id="search-btn">Buscar</button>
      <select id="filter-format">
        <option value="">Todos</option>
        <option value="mp3">MP3</option>
        <option value="flac">FLAC</option>
        <option value="wav">WAV</option>
        <option value="alac">ALAC</option>
      </select>
    </div>

    <div id="search-results"></div>
  <div id="search-progress" class="progress-message"></div>
</main>

  <script>
const token = localStorage.getItem('token') || '';
const input = document.getElementById('search-input');
const btn = document.getElementById('search-btn');
const resultsContainer = document.getElementById('search-results');
const progressEl = document.getElementById('search-progress');

btn.addEventListener('click', handleSearch);
input.addEventListener('keypress', e => { if(e.key==='Enter') handleSearch(); });

async function handleSearch() {
  const query = input.value.trim();
  if(!query) return;
  
  resultsContainer.innerHTML = '<p class="loading">Buscando...</p>';
  progressEl.textContent = ''; // limpiar mensaje de progreso

  // Resultados locales
  try {
    const res = await fetch(`/api/search?q=${encodeURIComponent(query)}`, {
      headers: { 'x-token': token }
    });
    const data = await res.json();
    renderLocalResults(data);
  } catch (err) {
    console.error('Error en búsqueda local:', err);
  }

  // Resultados de Internet Archive
  await buscarInternetArchive(query);
}

function renderLocalResults({ canciones = [], albums = [], artists = [] }) {
  // No limpiamos el contenedor para dejar lugar a IA, solo agregamos contenido local
  resultsContainer.innerHTML = '';

  const renderGroup = (title, items, renderItem) => {
    if(!items.length) return;
    const h = document.createElement('h3'); h.textContent = title;
    resultsContainer.appendChild(h);
    const grid = document.createElement('div'); grid.className='result-grid';
    items.forEach(item => grid.appendChild(renderItem(item)));
    resultsContainer.appendChild(grid);
  };

  renderGroup('Artistas (Locales)', artists, artista => 
    createCard(artista.nombre, '', 'Artista', artista.imagen, () => location.href=`artista_dev.html?id=${artista.id}`)
  );
  renderGroup('Álbumes (Locales)', albums, album => 
    createCard(album.titulo, album.autor, 'Álbum', album.portada, () => location.href=`album_dev.html?id=${album.id}`)
  );
  renderGroup('Canciones (Locales)', canciones, song => 
    createCard(song.titulo, song.artista, song.formato?.toUpperCase() || 'LOCAL', song.portada, () => location.href=`album_dev.html?id=${song.albumId}&song=${song.id}`)
  );
}

function createCard(title, subtitle, tag, imgSrc, onClick) {
  const div = document.createElement('div');
  div.classList.add('result-card');
  div.innerHTML = `
    <img src="${imgSrc}" alt="${title}" class="result-img">
    <div class="result-info">
      <h3>${title}</h3>
      <p>${subtitle}</p>
      <span class="format-tag">${tag}</span>
    </div>
  `;
  div.onclick = onClick;
  return div;
}

// ===================== INTERNET ARCHIVE =====================
async function buscarInternetArchive(query) {
  progressEl.textContent = 'Buscando en Internet Archive... Esto puede tardar unos segundos.';

  const palabras = query.trim().split(/\s+/);

  // Generar todas las combinaciones posibles de 1 a N palabras
  const combinaciones = [];
  for (let i = 0; i < palabras.length; i++) {
    for (let j = i; j < palabras.length; j++) {
      combinaciones.push(palabras.slice(i, j + 1).join(' '));
    }
  }

  const formatos = ['mp3','flac','wav','m4a'];
  const todosResultados = [];
  let count = 0;

  for (const combo of combinaciones) {
    count++;
    progressEl.textContent = `Buscando combinaciones (${count}/${combinaciones.length}) (Esto puede tardar unos segundos)...`;

    const keywords = `"${combo}"`;
    const fetches = formatos.map(f =>
      fetch(`https://archive.org/advancedsearch.php?q=(title:${keywords} OR creator:${keywords}) AND mediatype:audio AND format:${f}&fl[]=identifier,title,creator,format&sort[]=downloads+desc&rows=30&page=1&output=json`)
        .then(res => res.json())
        .then(data => data.response?.docs || [])
    );

    const resultadosPorFormato = await Promise.all(fetches);
    todosResultados.push(...[].concat(...resultadosPorFormato));
  }

  // Contar cuántas veces aparece cada identifier (para relevancia)
  const contador = {};
  todosResultados.forEach(item => {
    contador[item.identifier] = (contador[item.identifier] || 0) + 1;
  });

  // Eliminar duplicados
  const resultadosUnicos = Object.values(
    todosResultados.reduce((acc, item) => {
      if (!acc[item.identifier]) acc[item.identifier] = item;
      return acc;
    }, {})
  );

  // Ordenar por coincidencias (más coincidencias arriba)
  resultadosUnicos.sort((a, b) => contador[b.identifier] - contador[a.identifier]);

  progressEl.textContent = ''; // limpiar mensaje de progreso

  if (!resultadosUnicos.length) {
    resultsContainer.innerHTML += '<p>No se encontraron resultados en IA.</p>';
    return;
  }

  const h = document.createElement('h3');
  h.textContent = 'Resultados de Internet Archive';
  resultsContainer.appendChild(h);

  resultadosUnicos.forEach(item => {
    const ext = item.format ? item.format.join(', ') : 'Desconocido';
    const identifier = item.identifier;
    const div = createCard(
      item.title || 'Sin título',
      item.creator || 'Autor desconocido',
      ext,
      `https://archive.org/services/img/${identifier}`,
      () => { window.location.href = `/protected/albumIA.html?id=${identifier}`; }
    );
    div.classList.add('search-card');
    resultsContainer.appendChild(div);
  });
}


</script>
</body>
</html>
